<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatogram Analyzer - Advanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa; 
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 600px;
            position: relative;
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-group {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 10px;
            /* --- KEY CHANGE: Updated color scheme --- */
            background: #00796b; 
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-top: 5px;
        }

        button:hover:not(:disabled) {
            /* --- KEY CHANGE: Updated hover color --- */
            background: #004d40;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .style-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 5px;
        }

        .range-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .range-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .range-item label {
            font-size: 13px;
            color: #555;
            min-width: 40px;
        }

        input[type="range"] {
            flex: 1;
            cursor: pointer;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .status-bar {
            margin-top: 20px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover:not(:disabled) {
            background: #545b62;
        }

        .button-success {
            background: #28a745;
        }

        .button-success:hover:not(:disabled) {
            background: #218838;
        }

        .button-danger {
            background: #dc3545;
        }

        .button-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .integration-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .table-container {
            max-height: 300px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-group button {
            flex: 1;
        }

        .color-picker {
            width: 50px;
            height: 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .fraction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .fraction-item button {
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
            margin-top: 0;
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr; /* Stack chart and controls vertically */
            }
            .chart-container {
                height: 450px; /* Adjust chart height for smaller screens */
            }
        }
        
        /* --- START: New Footer CSS --- */
        footer {
            text-align: center;
            color: #6c757d; /* a muted gray */
            margin-top: 40px;
            padding-top: 20px;
            font-size: 0.85rem;
            border-top: 1px solid #ddd;
        }
        footer p {
            margin-bottom: 0.5rem;
        }
        footer a {
            color: #00796b; /* use the primary color */
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        /* --- END: New Footer CSS --- */

    </style>
</head>
<body>
    <div class="container">
        <h1><img src="logo.png" alt="Logo" style="height: 28px; vertical-align: middle; margin-right: 10px;"> Advanced Chromatogram Analyzer V2.0</h1>
        
        <div class="main-grid">
            <div>
                <div class="chart-container">
                    <div id="plotlyChart"></div>
                </div>
                
                <div class="status-bar" id="statusBar">
                    Ready to import data. Upload √ÑKTA (TXT/TSV), CSV, or Excel file to begin.
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <h3>üìÇ Data Import</h3>
                    <div class="file-input-wrapper">
                        <button onclick="document.getElementById('fileInput').click()">
                            üìÅ Open √ÑKTA File (TXT/CSV)
                        </button>
                        <input type="file" id="fileInput" accept=".txt,.csv">
                    </div>
                    <button onclick="openCustomImport()">
                        ‚öôÔ∏è Custom Import (CSV/Excel)
                    </button>
                    <hr style="margin: 15px 0;">
                    <button onclick="saveSession()" id="saveSessionBtn" class="button-success" disabled>
                        üíæ Save Session
                    </button>
                    <div class="file-input-wrapper">
                        <button onclick="document.getElementById('loadSessionInput').click()" class="button-success">
                            üìÇ Load Session
                        </button>
                        <input type="file" id="loadSessionInput" accept=".json" onchange="loadSession(event)" style="display: none;">
                    </div>
                </div>

                <div class="control-group">
                    <h3>üìä Plot Selection & Styling</h3>
                    <div class="checkbox-group" id="plotCheckboxes">
                        <p style="color: #999; font-size: 13px;">Load data to see variables</p>
                    </div>
                    <button onclick="plotGraph()" id="plotBtn" disabled>
                        üìä Update Plot
                    </button>
                    <hr style="margin: 15px 0;">
                    <div class="range-control" style="gap: 5px;">
                        <div class="range-item">
                            <label for="xAxisStart" style="min-width: 80px;">X-axis Start:</label>
                            <input type="number" id="xAxisStart" step="1" disabled onchange="plotGraph()">
                        </div>
                        <div class="range-item">
                            <label for="xAxisEnd" style="min-width: 80px;">X-axis End:</label>
                            <input type="number" id="xAxisEnd" step="1" disabled onchange="plotGraph()">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Column Parameters</h3>
                    <details open>
                        <summary style="cursor: pointer; font-size: 0.9em;">Show Column Parameters</summary>
                        <div class="range-control" style="margin-top: 10px;">
                            <div class="range-item">
                                <label for="colLength" style="min-width: 120px;">Column length (mm):</label>
                                <input type="number" id="colLength" value="20" step="1">
                            </div>
                        </div>
                    </details>
                </div>

                <div class="control-group">
                    <h3>üìê Integration & Analysis</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 13px; color: #555;">Primary Variable:</label>
                        <select id="primaryVarSelect" disabled>
                            <option value="">Select variable...</option>
                        </select>
                    </div>
                    <div class="range-control">
                        <div class="range-item">
                            <label>Start:</label>
                            <input type="number" id="integStartValue" value="0" step="0.1" disabled>
                        </div>
                        <div class="range-item">
                            <label>End:</label>
                            <input type="number" id="integEndValue" value="0" step="0.1" disabled>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px; cursor: pointer;">
                            <input type="checkbox" id="showIntegrationLinesCheck" disabled onchange="plotGraph()" checked>
                            Show Integration Lines
                        </label>
                    </div>
                    <div class="integration-info" id="integrationInfo">
                        <div><strong>Area:</strong> <span id="integAreaVal">-</span></div>
                        <div><strong>Volume:</strong> <span id="integVolumeVal">-</span></div>
                        <div><strong>Range:</strong> <span id="integRangeVal">-</span></div>
                        <div><strong>Amount:</strong> <span id="integAmountVal">-</span></div>
                        <div style="border-top: 1px solid #ddd; margin-top: 5px; padding-top: 5px;">
                            <strong>Asymmetry (As):</strong> <span id="integAsymmetryVal">-</span>
                        </div>
                        <div><strong>HETP:</strong> <span id="integHETPVal">-</span></div>
                    </div>
                    <button onclick="openConcentrationCalculator()" id="calcBtn" disabled class="button-success">
                        üß™ Calculate Concentration
                    </button>
                </div>

                <div class="control-group">
                    <h3>üß´ Fractions</h3>
                    <button onclick="openFractionManager()" id="fractionBtn" disabled>
                        üìã Manage Fractions
                    </button>
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            <input type="checkbox" id="showFractionsCheck" disabled onchange="plotGraph()">
                            Show Fractions on Plot
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üé® Label Regions</h3>
                    <button onclick="openRegionManager()" id="regionBtn" disabled>
                        üìã Manage Regions
                    </button>
                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px;">
                            <input type="checkbox" id="showRegionsCheck" disabled onchange="plotGraph()" checked>
                            Show Regions on Plot
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üíæ Export & Actions</h3>
                    <button onclick="openSaveImageModal()" id="saveBtn" disabled>
                        üíæ Save as PNG
                    </button>
                    <button onclick="openFontSettings()" id="fontBtn" disabled class="button-secondary">
                        ‚öôÔ∏è Font and Style Settings
                    </button>
                    <button onclick="copyToClipboard()" id="copyBtn" disabled class="button-secondary">
                        üìã Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Import Modal -->
    <div id="customImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Custom Data Import</h2>
                <span class="close" onclick="closeModal('customImportModal')">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Select File:</label>
                <input type="file" id="customFileInput" accept=".csv,.xlsx,.xls">
            </div>
            
            <div class="form-group">
                <label>Delimiter (for CSV):</label>
                <select id="delimiterSelect">
                    <option value=",">Comma (,)</option>
                    <option value="\t">Tab</option>
                    <option value=";">Semicolon (;)</option>
                    <option value=" ">Space</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Header Row Number:</label>
                <input type="number" id="headerRowInput" value="0" min="0">
            </div>
            
            <button onclick="previewCustomFile()" class="button-secondary">Preview Data</button>
            
            <div class="table-container" id="previewTableContainer" style="display: none; margin-top: 15px;">
                <table id="previewTable"></table>
            </div>
            
            <div id="columnMappingSection" style="display: none; margin-top: 20px;">
                <h3>Map Columns to Variables</h3>
                <div id="columnMappings"></div>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="importCustomData()" id="importCustomBtn" disabled class="button-success">Import</button>
                <button onclick="closeModal('customImportModal')" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Concentration Calculator Modal -->
    <div id="concentrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Protein Concentration Calculator</h2>
                <span class="close" onclick="closeModal('concentrationModal')">&times;</span>
            </div>
            
            <div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Integration Results</h3>
                <div id="calcIntegrationResults"></div>
            </div>
            
            <h3 style="margin-bottom: 10px;">Beer-Lambert Law Parameters</h3>
            
            <div class="form-group">
                <label>Molar Extinction Coefficient (M‚Åª¬πcm‚Åª¬π):</label>
                <input type="number" id="extCoeffInput" value="1.0" step="0.01" oninput="calculateConcentration()">
            </div>
            
            <div class="form-group">
                <label for="pathLengthInput">Path Length (cm):</label>
                <input type="number" id="pathLengthInput" value="0.2" step="0.1" oninput="calculateConcentration()">
                <small class="form-text text-muted">Hint: Default for √ÑKTA U9-L flow cell is 2 mm (0.2 cm).</small>
            </div>
            
            <div class="form-group">
                <label>Molecular Weight (g/mol):</label>
                <input type="number" id="molecularWeightInput" value="1000" step="1" oninput="calculateConcentration()">
            </div>
            
            <div style="background: #d4edda; padding: 15px; border-radius: 4px; margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">Calculated Amount</h3>
                <div style="font-size: 24px; font-weight: bold; color: #155724;" id="calculatedAmount">0.000 mg</div>
            </div>
            
            <button onclick="closeModal('concentrationModal')" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Fraction Manager Modal -->
    <div id="fractionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Fraction Manager</h2>
                <span class="close" onclick="closeModal('fractionModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Add New Fraction</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                    <input type="number" id="newFractionPos" placeholder="Position (mL)" step="0.1">
                    <input type="text" id="newFractionLabel" placeholder="Label">
                    <button onclick="addFraction()" class="button-success">Add</button>
                </div>
            </div>
            
            <h3 style="margin-bottom: 10px;">Existing Fractions</h3>
            <div id="fractionList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #999;">No fractions defined</p>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="saveFractions()" class="button-success">Save Changes</button>
                <button onclick="closeModal('fractionModal')" class="button-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="regionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Region Manager</h2>
                <span class="close" onclick="closeModal('regionModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Add New Region</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 80px auto; gap: 10px; align-items: end;">
                    <input type="number" id="newRegionStart" placeholder="Start (mL)" step="0.1">
                    <input type="number" id="newRegionEnd" placeholder="End (mL)" step="0.1">
                    <input type="text" id="newRegionLabel" placeholder="Label (e.g., Wash)">
                    <input type="color" id="newRegionColor" class="form-control" value="#cccccc" title="Choose region color">
                    <button onclick="addRegion()" class="button-success">Add</button>
                </div>
            </div>
            
            <h3 style="margin-bottom: 10px;">Existing Regions</h3>
            <div id="regionList" style="max-height: 300px; overflow-y: auto;">
                <p style="color: #999;">No regions defined</p>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="saveRegions()" class="button-success">Save & Close</button>
            </div>
        </div>
    </div>

    <div id="saveImageModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Save Image Options</h2>
                <span class="close" onclick="closeModal('saveImageModal')">&times;</span>
            </div>
            <p>Choose a resolution scaling factor for the exported PNG image.</p>
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="saveImage(1)">1x (Screen Size)</button>
                <button onclick="saveImage(2)" class="button-success">2x (High Res)</button>
                <button onclick="saveImage(3)" class="button-success">3x (Ultra Res)</button>
            </div>
        </div>
    </div>
    <!-- END: New Save Image Modal -->

    <!-- START: New Font Settings Modal -->
    <div id="fontSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Font & Style Settings</h2>
                <span class="close" onclick="closeModal('fontSettingsModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Chart Title:</label>
                <input type="text" id="chartTitleInput" class="form-control">
            </div>
            <div class="form-group">
                <label>Global Font Family:</label>
                <select id="fontFamilySelect" class="form-select">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    <option value="'Courier New', Courier, monospace">Courier New</option>
                    <option value="Verdana, sans-serif">Verdana</option>
                </select>
            </div>            
            <hr>
            <div class="row g-3">
                <div class="col-md-6 form-group">
                    <label>Global Font Size (px):</label>
                    <input type="number" id="globalFontSize" class="form-control" oninput="updateAllFontSizes(this.value)">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-4 form-group">
                    <label>Title Font Size (px):</label>
                    <input type="number" id="titleFontSize" class="form-control">
                </div>
                <div class="col-md-4 form-group">
                    <label>Axis Font Size (px):</label>
                    <input type="number" id="axisFontSize" class="form-control">
                </div>
                <div class="col-md-4 form-group">
                    <label>Fraction Font Size (px):</label>
                    <input type="number" id="fractionFontSize" class="form-control">
                </div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="applyFontSettings()" class="button-success">Apply Changes</button>
                <button onclick="closeModal('fontSettingsModal')" class="button-secondary">Close</button>
            </div>
        </div>
    </div>

    <footer>
        <p>
            <strong>Developed by:</strong> Anindya Karmaker, PhD Candidate, McDonald-Nandi Lab.
        </p>
        <p>
            <strong>Source Code:</strong> 
            <a href="https://github.com/Anindya-Karmaker/Chromatogram-Plotter-Analyzer" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 4px;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                View on GitHub
            </a>
        </p>
        <p>
            <strong>Funding:</strong> The development of this tool was supported by the National Science Foundation Partnerships for Innovation (PFI) program under Grant No. 2016563.
        </p>
        <p>
            <strong>License:</strong> All rights reserved. Unauthorized copy or distribution of this application is strictly prohibited.
        </p>
        <p>
            <strong>Data Privacy:</strong> This is a client-side tool. No data is uploaded to, saved on, or transmitted to any server.
        </p>
        <p>
            <strong>Disclaimer:</strong> This tool is for research and planning purposes only. The user is solely responsible for verifying all calculations and results before use.
        </p>
    </footer>


    <script>
        let rawData = {};
        let originalRawData = {};
        let currentFileName = '';
        let fullDataRange = { min: 0, max: 100 };
        let selectedVariables = [];
        let plotColors = {};
        let plotStyles = {};
        let plotLabels = {};
        let fractionData = [];
        let customParsedData = null;
        let integrationResults = { area: 0, volume: 0, start: 0, end: 0 };
        let isRelayouting = false;
        let concentrationParams = { extCoeff: 1.0, pathLength: 0.2, mw: 1000 };
        let columnParams = { length_mm: 20 };
        let fontSettings = { chartTitle: 'Chromatogram Analysis', family: 'Arial, sans-serif', titleSize: 18, axisSize: 14, fractionSize: 10 };
        let regionData = [];
        
        const defaultColors = ['#0066CC', '#00CC66', '#CC0000', '#CC00CC', '#00CCCC', '#FF9900', '#666666', '#FF00FF'];
        const dashStyles = {
            'solid': 'solid',
            'dash': 'dash',
            'dot': 'dot',
            'dashdot': 'dashdot'
        };

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentFileName = file.name;
            updateStatus('Loading: ' + file.name + '...');
            
            Papa.parse(file, {
                delimiter: '\t',
                skipEmptyLines: true,
                complete: function(results) {
                    processAktaFile(results.data);
                },
                error: function(error) {
                    updateStatus('Error: ' + error.message);
                }
            });
        });

        document.getElementById('colLength').addEventListener('change', function() {
            columnParams.length_mm = parseFloat(this.value);
            updateIntegration(); 
        });

        function saveSession() {
            if (!originalRawData || Object.keys(originalRawData).length === 0) {
                alert("No data loaded to save.");
                return;
            }

            const plotCheckboxesState = [];
            document.querySelectorAll('#plotCheckboxes .checkbox-item input[type="checkbox"]').forEach(cb => {
                plotCheckboxesState.push({
                    name: cb.value,
                    checked: cb.checked
                });
            });

            const sessionData = {
                version: '1.5',
                fileName: currentFileName,
                originalRawData: originalRawData,
                fontSettings: fontSettings,
                columnParams: columnParams,
                concentrationParams: concentrationParams,
                fractionData: fractionData,
                regionData: regionData,
                uiState: {
                    plotCheckboxes: plotCheckboxesState,
                    plotLabels: plotLabels,
                    plotColors: plotColors,
                    plotStyles: plotStyles,
                    primaryVar: document.getElementById('primaryVarSelect').value,
                    integStart: document.getElementById('integStartValue').value,
                    integEnd: document.getElementById('integEndValue').value,
                    xAxisStart: document.getElementById('xAxisStart').value,
                    xAxisEnd: document.getElementById('xAxisEnd').value,
                    showFractions: document.getElementById('showFractionsCheck').checked,
                    showRegions: document.getElementById('showRegionsCheck').checked,
                    showIntegrationLines: document.getElementById('showIntegrationLinesCheck').checked
                }
            };

            const jsonString = JSON.stringify(sessionData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.download = `${currentFileName.replace(/\.[^/.]+$/, '')}_session_${date}.json`;
            link.href = URL.createObjectURL(blob);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadSession(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const sessionData = JSON.parse(e.target.result);

                    if (!sessionData.originalRawData || !sessionData.uiState) {
                        throw new Error("Invalid session file format.");
                    }

                    currentFileName = sessionData.fileName;
                    originalRawData = sessionData.originalRawData;
                    rawData = JSON.parse(JSON.stringify(originalRawData)); 
                    fontSettings = sessionData.fontSettings;
                    columnParams = sessionData.columnParams;
                    concentrationParams = sessionData.concentrationParams;
                    fractionData = sessionData.fractionData;
                    regionData = sessionData.regionData;
                    
                    onDataImported();

                    document.getElementById('colLength').value = columnParams.length_mm;
                    document.getElementById('primaryVarSelect').value = sessionData.uiState.primaryVar;
                    document.getElementById('integStartValue').value = sessionData.uiState.integStart;
                    document.getElementById('integEndValue').value = sessionData.uiState.integEnd;
                    document.getElementById('xAxisStart').value = sessionData.uiState.xAxisStart;
                    document.getElementById('xAxisEnd').value = sessionData.uiState.xAxisEnd;
                    document.getElementById('showFractionsCheck').checked = sessionData.uiState.showFractions;
                    document.getElementById('showRegionsCheck').checked = sessionData.uiState.showRegions;
                    document.getElementById('showIntegrationLinesCheck').checked = sessionData.uiState.showIntegrationLines;

                    sessionData.uiState.plotCheckboxes.forEach(state => {
                        const checkbox = document.getElementById(`check_${state.name}`);
                        if (checkbox) checkbox.checked = state.checked;
                    });
                    plotLabels = sessionData.uiState.plotLabels;
                    plotColors = sessionData.uiState.plotColors;
                    plotStyles = sessionData.uiState.plotStyles;

                    plotGraph();
                    updateStatus(`Session loaded: ${currentFileName}`);

                } catch (error) {
                    console.error("Error loading session:", error);
                    alert("Failed to load session file. It may be corrupt or in an invalid format.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function processAktaFile(data) {
            try {
                if (data.length < 3) {
                    updateStatus('Error: File has too few rows');
                    return;
                }
                const headers = data[1] || [];
                const dataRows = data.slice(2);
                
                originalRawData = {}; 
                const columnMap = [
                    { pattern: 'UV', name: 'UV' }, { pattern: 'ph', name: 'pH', caseSensitive: false },
                    { pattern: 'Cond', name: 'Conductivity' }, { pattern: 'Conc', name: 'Gradient' },
                    { pattern: 'flow', name: 'Flow rate', caseSensitive: false }, { pattern: 'pressure', name: 'System Pressure', caseSensitive: false },
                    { pattern: 'Fraction', name: 'Fraction' }
                ];
                
                columnMap.forEach(function(mapping) {
                    const idx = headers.findIndex(h => h && (mapping.caseSensitive === false ? h.toLowerCase() : h).includes(mapping.caseSensitive === false ? mapping.pattern.toLowerCase() : mapping.pattern));
                    
                    if (idx >= 0) {
                        if (mapping.name === 'Fraction') {
                            fractionData = [];
                            dataRows.forEach(row => {
                                const pos = parseFloat(row[idx]);
                                if (!isNaN(pos) && row[idx + 1]) fractionData.push({ position: pos, label: row[idx + 1], show: true });
                            });
                        } else {
                            originalRawData[mapping.name] = { x: [], y: [] };
                            dataRows.forEach(row => {
                                const x = parseFloat(row[idx]);
                                const y = parseFloat(row[idx+1]);
                                if (!isNaN(x)) originalRawData[mapping.name].x.push(x);
                                if (!isNaN(x) && !isNaN(y)) originalRawData[mapping.name].y.push(y);
                            });
                        }
                    }
                });
                
                Object.keys(originalRawData).forEach(key => {
                    if (originalRawData[key].x.length === 0) delete originalRawData[key];
                });
                
                if (Object.keys(originalRawData).length === 0) {
                    updateStatus('Error: No valid data found in file');
                    return;
                }
                
                rawData = JSON.parse(JSON.stringify(originalRawData)); 
                onDataImported();
                
            } catch (error) {
                updateStatus('Error processing file: ' + error.message);
            }
        }

        function importCustomData() {
            if (!customParsedData) return;
            const headerRow = parseInt(document.getElementById('headerRowInput').value);
            const dataRows = customParsedData.slice(headerRow + 1);
            
            originalRawData = {}; 
            const variables = ['UV', 'pH', 'Conductivity', 'Gradient', 'Flow rate', 'System Pressure'];
            
            variables.forEach(varName => {
                const xIdx = document.getElementById(`x_${varName}`).value;
                const yIdx = document.getElementById(`y_${varName}`).value;
                if (xIdx !== '' && yIdx !== '') {
                    originalRawData[varName] = { x: [], y: [] };
                    dataRows.forEach(row => {
                        const x = parseFloat(row[xIdx]);
                        const y = parseFloat(row[yIdx]);
                        if (!isNaN(x) && !isNaN(y)) {
                            originalRawData[varName].x.push(x);
                            originalRawData[varName].y.push(y);
                        }
                    });
                    if (originalRawData[varName].x.length === 0) delete originalRawData[varName];
                }
            });

            if (Object.keys(originalRawData).length === 0) {
                alert('No valid data could be imported. Please check your column mappings.');
                return;
            }
            
            currentFileName = document.getElementById('customFileInput').files[0].name;
            closeModal('customImportModal');
            
            rawData = JSON.parse(JSON.stringify(originalRawData)); 
            onDataImported();
        }

        function onDataImported() {
            let globalMinX = Infinity;
            let globalMaxX = -Infinity;

            Object.keys(rawData).forEach(function(key) {
                const x_values = rawData[key].x;
                if (x_values && x_values.length > 0) {
                    for (let i = 0; i < x_values.length; i++) {
                        if (x_values[i] < globalMinX) globalMinX = x_values[i];
                        if (x_values[i] > globalMaxX) globalMaxX = x_values[i];
                    }
                }
            });

            if (globalMinX === Infinity) {
                fullDataRange.min = 0;
                fullDataRange.max = 100;
            } else {
                fullDataRange.min = globalMinX;
                fullDataRange.max = globalMaxX;
            }
            
            document.getElementById('xAxisStart').value = fullDataRange.min.toFixed(2);
            document.getElementById('xAxisEnd').value = fullDataRange.max.toFixed(2);

            plotLabels = {};
            Object.keys(rawData).forEach(function(varName, idx) {
                plotLabels[varName] = varName;
                if (!plotColors[varName]) {
                    plotColors[varName] = defaultColors[idx % defaultColors.length];
                }
                if (!plotStyles[varName]) {
                    plotStyles[varName] = 'solid';
                }
            });
            
            document.getElementById('plotBtn').disabled = false;
            document.getElementById('primaryVarSelect').disabled = false;
            document.getElementById('integStartValue').disabled = false;
            document.getElementById('integEndValue').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
            document.getElementById('fontBtn').disabled = false;
            document.getElementById('calcBtn').disabled = false;
            document.getElementById('fractionBtn').disabled = false;
            document.getElementById('showFractionsCheck').disabled = false;
            document.getElementById('showIntegrationLinesCheck').disabled = false;
            document.getElementById('regionBtn').disabled = false;
            document.getElementById('showRegionsCheck').disabled = false;
            document.getElementById('xAxisStart').disabled = false;
            document.getElementById('xAxisEnd').disabled = false;
            document.getElementById('saveSessionBtn').disabled = false; 
            
            const container = document.getElementById('plotCheckboxes');
            container.innerHTML = '';
            
            Object.keys(rawData).forEach(function(varName, idx) {
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '10px';
                
                const checkDiv = document.createElement('div');
                checkDiv.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'check_' + varName;
                checkbox.value = varName;
                checkbox.checked = idx < 2;
                
                const label = document.createElement('label');
                label.htmlFor = 'check_' + varName;
                label.textContent = varName;
                
                checkDiv.appendChild(checkbox);
                checkDiv.appendChild(label);
                wrapper.appendChild(checkDiv);
                
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.value = plotLabels[varName];
                labelInput.placeholder = 'Custom Label';
                labelInput.style.marginTop = '5px';
                labelInput.onchange = function() {
                    plotLabels[varName] = this.value;
                };
                wrapper.appendChild(labelInput);

                const styleControls = document.createElement('div');
                styleControls.className = 'style-controls';
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.className = 'color-picker';
                colorInput.value = plotColors[varName];
                colorInput.onchange = function() {
                    plotColors[varName] = this.value;
                };
                
                const styleSelect = document.createElement('select');
                Object.keys(dashStyles).forEach(function(style) {
                    const option = document.createElement('option');
                    option.value = style;
                    option.textContent = style.charAt(0).toUpperCase() + style.slice(1);
                    styleSelect.appendChild(option);
                });
                styleSelect.value = plotStyles[varName];
                styleSelect.onchange = function() {
                    plotStyles[varName] = this.value;
                };
                
                styleControls.appendChild(colorInput);
                styleControls.appendChild(styleSelect);
                wrapper.appendChild(styleControls);
                
                container.appendChild(wrapper);
            });
            
            const select = document.getElementById('primaryVarSelect');
            select.innerHTML = '<option value="">Select variable...</option>';
            Object.keys(rawData).forEach(function(varName) {
                const option = document.createElement('option');
                option.value = varName;
                option.textContent = varName;
                select.appendChild(option);
            });
            
            if (rawData['UV']) {
                select.value = 'UV';
            }
            
            setupIntegrationInputs();
            updateStatus('Data loaded: ' + Object.keys(rawData).length + ' variables found');
            plotGraph();
        }

        function openSaveImageModal() {
            document.getElementById('saveImageModal').style.display = 'block';
        }

        function openFontSettings() {
            document.getElementById('chartTitleInput').value = fontSettings.chartTitle; 
            document.getElementById('fontFamilySelect').value = fontSettings.family;
            document.getElementById('titleFontSize').value = fontSettings.titleSize;
            document.getElementById('axisFontSize').value = fontSettings.axisSize;
            document.getElementById('fractionFontSize').value = fontSettings.fractionSize;
            document.getElementById('globalFontSize').value = ''; 
            document.getElementById('fontSettingsModal').style.display = 'block';
        }

        function applyFontSettings() {
            fontSettings.chartTitle = document.getElementById('chartTitleInput').value; 
            fontSettings.family = document.getElementById('fontFamilySelect').value;
            fontSettings.titleSize = parseInt(document.getElementById('titleFontSize').value);
            fontSettings.axisSize = parseInt(document.getElementById('axisFontSize').value);
            fontSettings.fractionSize = parseInt(document.getElementById('fractionFontSize').value);
            closeModal('fontSettingsModal');
            plotGraph();
        }

        function updateAllFontSizes(size) {
            if (!size || isNaN(size)) return;
            const newSize = parseInt(size);
            document.getElementById('titleFontSize').value = newSize + 4;
            document.getElementById('axisFontSize').value = newSize;
            document.getElementById('fractionFontSize').value = newSize - 2 > 6 ? newSize - 2 : 6;
        }

        function openRegionManager() {
            renderRegionList();
            document.getElementById('regionModal').style.display = 'block';
        }

        function renderRegionList() {
            const container = document.getElementById('regionList');
            if (regionData.length === 0) {
                container.innerHTML = '<p style="color: #999;">No regions defined</p>';
                return;
            }
            container.innerHTML = '';
            regionData.sort((a, b) => a.start - b.start);
            
            regionData.forEach((region, idx) => {
                const div = document.createElement('div');
                div.className = 'fraction-item'; 

                div.innerHTML = `
                    <!-- View State -->
                    <div id="view-region-${idx}" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background-color: ${region.color}; border: 1px solid #ccc; flex-shrink: 0;"></div>
                            <div><strong>${region.label}</strong> (${region.start.toFixed(2)} - ${region.end.toFixed(2)} mL)</div>
                        </div>
                        <div class="button-group" style="flex-shrink: 0;">
                            <button class="button-secondary" style="width: auto; padding: 5px 10px;" onclick="toggleRegionEdit(${idx})">Edit</button>
                            <button class="button-danger" style="width: auto; padding: 5px 10px;" onclick="deleteRegion(${idx})">Delete</button>
                        </div>
                    </div>

                    <!-- Edit State (hidden by default) -->
                    <div id="edit-region-${idx}" style="display: none; width: 100%; gap: 10px;">
                        <input type="number" class="form-control" value="${region.start.toFixed(2)}" step="0.1" style="width: 90px;">
                        <input type="number" class="form-control" value="${region.end.toFixed(2)}" step="0.1" style="width: 90px;">
                        <input type="text" class="form-control" value="${region.label}">
                        <input type="color" class="form-control" value="${region.color}" style="min-width: 50px; padding: 2px;">
                        <button class="button-success" style="width: auto; padding: 5px 10px;" onclick="saveRegionEdit(${idx})">Save</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleRegionEdit(index) {
            const viewDiv = document.getElementById(`view-region-${index}`);
            const editDiv = document.getElementById(`edit-region-${index}`);
            if (viewDiv.style.display !== 'none') {
                viewDiv.style.display = 'none';
                editDiv.style.display = 'flex';
            } else {
                viewDiv.style.display = 'flex';
                editDiv.style.display = 'none';
            }
        }

        function saveRegionEdit(index) {
            const editDiv = document.getElementById(`edit-region-${index}`);
            const inputs = editDiv.querySelectorAll('input');
            
            const start = parseFloat(inputs[0].value);
            const end = parseFloat(inputs[1].value);
            const label = inputs[2].value.trim();
            const color = inputs[3].value;

            if (isNaN(start) || isNaN(end) || !label || end <= start) {
                alert('Please enter a valid Start, End, and Label. End value must be greater than Start.');
                return;
            }

            regionData[index] = { start, end, label, color };
            
            renderRegionList();
        }

        function addRegion() {
            const start = parseFloat(document.getElementById('newRegionStart').value);
            const end = parseFloat(document.getElementById('newRegionEnd').value);
            const label = document.getElementById('newRegionLabel').value.trim();
            const color = document.getElementById('newRegionColor').value;

            if (isNaN(start) || isNaN(end) || !label || end <= start) {
                alert('Please enter a valid Start, End, and Label. End value must be greater than Start.');
                return;
            }

            regionData.push({ start, end, label, color });
            document.getElementById('newRegionStart').value = '';
            document.getElementById('newRegionEnd').value = '';
            document.getElementById('newRegionLabel').value = '';
            renderRegionList();
        }
        
        function deleteRegion(index) {
            regionData.splice(index, 1);
            renderRegionList();
        }

        function saveRegions() {
            closeModal('regionModal');
            if (document.getElementById('showRegionsCheck').checked) {
                plotGraph();
            }
            updateStatus('Regions saved: ' + regionData.length + ' region(s)');
        }

        function setupIntegrationInputs() {
            const primaryVar = document.getElementById('primaryVarSelect').value;
            if (!primaryVar || !rawData[primaryVar]) return;
            
            const data = rawData[primaryVar];
            const min = Math.min.apply(null, data.x);
            const max = Math.max.apply(null, data.x);
            const range = max - min;
            
            const start = min + range * 0.25;
            const end = min + range * 0.75;
            
            document.getElementById('integStartValue').value = start.toFixed(2);
            document.getElementById('integEndValue').value = end.toFixed(2);
            
            updateIntegration();
        }

        function handleRelayout(eventData) {
            if (isRelayouting) return;

            const xrange = eventData['xaxis.range[0]'] ? [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']] : null;
            
            if (xrange) {
                document.getElementById('xAxisStart').value = xrange[0].toFixed(2);
                document.getElementById('xAxisEnd').value = xrange[1].toFixed(2);
            }

            if (!xrange) return;

            isRelayouting = true; 

            const updateLayout = {};
            
            selectedVariables.forEach(function(varName, idx) {
                const data = rawData[varName];
                if (!data || data.x.length === 0) return;

                let minY = null;
                let maxY = null;
                
                for (let i = 0; i < data.x.length; i++) {
                    if (data.x[i] >= xrange[0] && data.x[i] <= xrange[1]) {
                        const yVal = data.y[i];
                        if (minY === null || yVal < minY) minY = yVal;
                        if (maxY === null || yVal > maxY) maxY = yVal;
                    }
                }
                
                if (minY !== null && maxY !== null) {
                    const axisId = idx === 0 ? 'yaxis' : 'yaxis' + (idx + 1);
                    const range = maxY - minY;
                    const padding = range === 0 ? 0.1 : range * 0.05;
                    updateLayout[axisId + '.range'] = [minY - padding, maxY + padding];
                }
            });
            
            if (Object.keys(updateLayout).length > 0) {
                Plotly.relayout('plotlyChart', updateLayout).then(() => {
                    isRelayouting = false;
                });
            } else {
                 isRelayouting = false;
            }
        }
        
        function plotGraph() {
            const checkedBoxes = document.querySelectorAll('#plotCheckboxes input[type="checkbox"]:checked');
            selectedVariables = [];
            checkedBoxes.forEach(function(cb) {
                selectedVariables.push(cb.value);
            });
            
            if (selectedVariables.length === 0) {
                Plotly.purge('plotlyChart');
                updateStatus('Please select at least one variable to plot');
                return;
            }
            
            const traces = [];
            const annotations = [];
            const shapes = []; 

            const numSecondaryAxes = Math.max(0, selectedVariables.length - 1);
            const spacePerAxis = 0.08; 
            const plotDomainEnd = 1.0 - (numSecondaryAxes * spacePerAxis);

            selectedVariables.forEach(function(varName, idx) {
                const data = rawData[varName];
                traces.push({
                    x: data.x, 
                    y: data.y, 
                    name: plotLabels[varName] || varName, type: 'scatter', mode: 'lines',
                    line: { color: plotColors[varName], dash: dashStyles[plotStyles[varName]], width: 2 },
                    yaxis: idx === 0 ? 'y' : 'y' + (idx + 1)
                });
            });
            
            if (document.getElementById('showIntegrationLinesCheck').checked) {
                const startVal = parseFloat(document.getElementById('integStartValue').value);
                const endVal = parseFloat(document.getElementById('integEndValue').value);
                
                if (!isNaN(startVal)) {
                    shapes.push({
                        type: 'line', xref: 'x', yref: 'paper', x0: startVal, y0: 0, x1: startVal, y1: 1,
                        line: { color: 'red', width: 2, dash: 'solid' }
                    });
                }
                
                if (!isNaN(endVal)) {
                    shapes.push({
                        type: 'line', xref: 'x', yref: 'paper', x0: endVal, y0: 0, x1: endVal, y1: 1,
                        line: { color: 'red', width: 2, dash: 'solid' }
                    });
                }
            }
            
            if (document.getElementById('showFractionsCheck').checked && fractionData.length > 0) {
                fractionData.forEach(function(fraction) {
                    if (fraction.show) {
                        traces.push({
                            x: [fraction.position, fraction.position], y: [0, 1], yaxis: 'y', type: 'scatter', mode: 'lines',
                            line: { color: 'gray', dash: 'dot', width: 1.5 },
                            name: fraction.label, 
                            showlegend: false, 
                            hoverinfo: 'none'
                        });
                        annotations.push({
                            x: fraction.position, y: 0, xref: 'x', yref: 'paper', text: fraction.label,
                            showarrow: false, font: { size: fontSettings.fractionSize, color: '#444' },
                            yanchor: 'top', yshift: -5, xanchor: 'center', textangle: -45
                        });
                    }
                });
            }

            if (document.getElementById('showRegionsCheck').checked && regionData.length > 0) {
                regionData.forEach(region => {
                    shapes.push({
                        type: 'rect', xref: 'x', yref: 'paper', x0: region.start, y0: 0, x1: region.end, y1: 1,
                        fillcolor: region.color, opacity: 0.2, line: { width: 0 }, layer: 'below'
                    });
                    annotations.push({
                        x: (region.start + region.end) / 2, y: 1.05, xref: 'x', yref: 'paper',
                        text: `<b>${region.label}</b>`, showarrow: false,
                        font: { size: fontSettings.axisSize, color: 'black' }, xanchor: 'center'
                    });
                    traces.push({
                        x: [null], y: [null], type: 'scatter', mode: 'markers', name: region.label,
                        marker: { symbol: 'square', color: region.color, size: 15, line: { width: 1, color: '#666' } },
                        showlegend: true
                    });
                });
            }
            
            const xAxisStart = parseFloat(document.getElementById('xAxisStart').value);
            const xAxisEnd = parseFloat(document.getElementById('xAxisEnd').value);
            let xAxisRange = null;
            if (!isNaN(xAxisStart) && !isNaN(xAxisEnd) && xAxisStart < xAxisEnd) {
                xAxisRange = [xAxisStart, xAxisEnd];
            }

            const layout = {
                font: { family: fontSettings.family },
                title: { 
                    text: fontSettings.chartTitle,
                    font: { size: fontSettings.titleSize }
                },
                margin: { t: 50, b: 150 },
                legend: {
                    orientation: 'h', yanchor: 'top', y: -0.3, xanchor: 'center', x: 0.5
                },
                xaxis: {
                    title: 'Volume (mL)', domain: [0, plotDomainEnd], automargin: true,
                    titlefont: { size: fontSettings.axisSize },
                    tickfont: { size: fontSettings.axisSize },
                    range: xAxisRange
                },
                annotations: annotations,
                shapes: shapes,
                height: 550,
                hovermode: 'x unified'
            };
            
            selectedVariables.forEach(function(varName, idx) {
                const axisId = idx === 0 ? 'yaxis' : 'yaxis' + (idx + 1);
                layout[axisId] = {
                    title: plotLabels[varName] || varName,
                    titlefont: { color: plotColors[varName], size: fontSettings.axisSize },
                    tickfont: { color: plotColors[varName], size: fontSettings.axisSize },
                    automargin: true
                };

                
                if (idx > 0) {
                    layout[axisId].overlaying = 'y';
                    layout[axisId].side = 'right';
                    layout[axisId].position = plotDomainEnd + (idx - 1) * spacePerAxis;
                    layout[axisId].showgrid = false;
                    layout[axisId].showline = true;
                    layout[axisId].linewidth = 2;
                    layout[axisId].linecolor = plotColors[varName];
                }
            });
            
            const config = {
                responsive: true, displayModeBar: true, displaylogo: false,
                modeBarButtonsToAdd: ['pan2d', 'zoom2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                toImageButtonOptions: {
                    format: 'png', filename: currentFileName.replace(/\.[^/.]+$/, '') + '_chromatogram',
                    height: 800, width: 1200, scale: 2
                }
            };
            
            Plotly.newPlot('plotlyChart', traces, layout, config);
            
            document.getElementById('plotlyChart').on('plotly_relayout', handleRelayout);

            updateStatus('Plotted ' + selectedVariables.length + ' variable(s)');
            updateIntegration();
        }

        function snapToFraction(inputId) {
            if (!document.getElementById('showFractionsCheck').checked || fractionData.length === 0) {
                return;
            }

            const inputElement = document.getElementById(inputId);
            const inputValue = parseFloat(inputElement.value);
            if (isNaN(inputValue)) return;

            let closestPosition = null;
            let minDifference = Infinity;

            fractionData.forEach(fraction => {
                if (fraction.show) { 
                    const difference = Math.abs(fraction.position - inputValue);
                    if (difference < minDifference) {
                        minDifference = difference;
                        closestPosition = fraction.position;
                    }
                }
            });

            
            if (closestPosition !== null) {
                inputElement.value = closestPosition.toFixed(2);
            }
        }

        function updateIntegration() {
            const primaryVar = document.getElementById('primaryVarSelect').value;
            const areaEl = document.getElementById('integAreaVal');
            const volumeEl = document.getElementById('integVolumeVal');
            const rangeEl = document.getElementById('integRangeVal');
            const asymmetryEl = document.getElementById('integAsymmetryVal');
            const hetpEl = document.getElementById('integHETPVal');

            const resetDisplay = () => {
                integrationResults = { area: 0, volume: 0, start: 0, end: 0 };
                areaEl.textContent = '-';
                volumeEl.textContent = '-';
                rangeEl.textContent = '-';
                asymmetryEl.textContent = '-';
                hetpEl.textContent = '-';
            };

            if (!primaryVar || !rawData[primaryVar]) {
                resetDisplay();
            } else {
                const startVal = parseFloat(document.getElementById('integStartValue').value);
                const endVal = parseFloat(document.getElementById('integEndValue').value);
                
                const data = rawData[primaryVar];
                const filtered = data.x.reduce((acc, x, i) => {
                    if (x >= startVal && x <= endVal) acc.push({ x, y: data.y[i] });
                    return acc;
                }, []);
                
                if (filtered.length > 2) {
                    let area = 0;
                    for (let i = 1; i < filtered.length; i++) {
                        area += (filtered[i].x - filtered[i-1].x) * (filtered[i].y + filtered[i-1].y) / 2;
                    }
                    const volume = endVal - startVal;
                    integrationResults = { area: area, volume: volume, start: startVal, end: endVal };
                    
                    areaEl.textContent = area.toFixed(2) + ' mL¬∑mAU';
                    volumeEl.textContent = volume.toFixed(2) + ' mL';
                    rangeEl.textContent = startVal.toFixed(2) + ' - ' + endVal.toFixed(2) + ' mL';

                    const metrics = calculatePeakMetrics(filtered);
                    asymmetryEl.textContent = metrics.asymmetry.toFixed(2);
                    hetpEl.textContent = metrics.hetp > 0 ? metrics.hetp.toFixed(2) + ' ¬µm' : 'N/A';

                } else {
                    resetDisplay();
                    rangeEl.textContent = startVal.toFixed(2) + ' - ' + endVal.toFixed(2) + ' mL';
                }
            }
            updateConcentrationDisplay();
        }

        function calculatePeakMetrics(peakData) {
            const defaults = { asymmetry: 0, hetp: 0 };
            if (peakData.length < 3) return defaults;

            let peakMax = { x: 0, y: -Infinity, index: -1 };
            peakData.forEach((p, i) => {
                if (p.y > peakMax.y) peakMax = { x: p.x, y: p.y, index: i };
            });
            if (peakMax.index === -1) return defaults;

            const startPoint = peakData[0];
            const endPoint = peakData[peakData.length - 1];
            const baselineSlope = (endPoint.y - startPoint.y) / (endPoint.x - startPoint.x);
            const getBaselineY = (x) => startPoint.y + (x - startPoint.x) * baselineSlope;
            
            const peakHeight = peakMax.y - getBaselineY(peakMax.x);
            if (peakHeight <= 0) return defaults;

            const interpolateX = (yTarget, startIndex, direction) => {
                for (let i = startIndex; i >= 0 && i < peakData.length - 1; i += direction) {
                    const p1 = peakData[i];
                    const p2 = peakData[i + direction];
                    if (!p1 || !p2) continue;
                    
                    const y1 = p1.y - getBaselineY(p1.x);
                    const y2 = p2.y - getBaselineY(p2.x);

                    if ((y1 >= yTarget && y2 <= yTarget) || (y1 <= yTarget && y2 >= yTarget)) {
                        if (y1 === y2) return p1.x;
                        const x = p1.x + (p2.x - p1.x) * (yTarget - y1) / (y2 - y1);
                        return x;
                    }
                }
                return null;
            };

            const x_10_leading = interpolateX(peakHeight * 0.10, peakMax.index, -1);
            const x_10_trailing = interpolateX(peakHeight * 0.10, peakMax.index, 1);
            const x_50_leading = interpolateX(peakHeight * 0.50, peakMax.index, -1);
            const x_50_trailing = interpolateX(peakHeight * 0.50, peakMax.index, 1);

            let asymmetry = 0;
            if (x_10_leading && x_10_trailing) {
                const A = peakMax.x - x_10_leading;
                const B = x_10_trailing - peakMax.x;
                if (A > 0) asymmetry = B / A;
            }

            let hetp = 0;
            if (x_50_leading && x_50_trailing) {
                const retentionTime = peakMax.x;
                const widthAtHalfHeight = x_50_trailing - x_50_leading;
                if (widthAtHalfHeight > 0) {
                    const N = 5.54 * Math.pow(retentionTime / widthAtHalfHeight, 2);
                    if (N > 0 && columnParams.length_mm > 0) {
                        hetp = (columnParams.length_mm / N) * 1000; // Convert mm to ¬µm
                    }
                }
            }
            
            return { asymmetry, hetp };
        }

        function saveImage(scale = 1) {
            const chartDiv = document.getElementById('plotlyChart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;

            Plotly.downloadImage('plotlyChart', {
                format: 'png',
                width: width,
                height: height,
                scale: scale, 
                filename: currentFileName.replace(/\.[^/.]+$/, '') + '_chromatogram'
            });
            closeModal('saveImageModal');
        }

        function copyToClipboard() {
            const chartDiv = document.getElementById('plotlyChart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;

            Plotly.toImage('plotlyChart', { 
                format: 'png', 
                width: width, 
                height: height 
            })
                .then(dataUrl => fetch(dataUrl))
                .then(res => res.blob())
                .then(blob => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                        .then(() => updateStatus('Image copied to clipboard!'))
                        .catch(err => updateStatus('Error copying to clipboard: ' + err));
                });
        }


        function openCustomImport() { document.getElementById('customImportModal').style.display = 'block'; }
        document.getElementById('customFileInput').addEventListener('change', function() {
            document.getElementById('previewTableContainer').style.display = 'none';
            document.getElementById('columnMappingSection').style.display = 'none';
            document.getElementById('importCustomBtn').disabled = true;
        });

        function previewCustomFile() {
            const file = document.getElementById('customFileInput').files[0];
            if (!file) { alert('Please select a file first'); return; }

            if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                const reader = new FileReader();
                reader.onload = e => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    customParsedData = jsonData;
                    displayPreview(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else {
                let delimiter = document.getElementById('delimiterSelect').value;
                if (delimiter === '\\t') {
                    delimiter = '\t';
                }
                Papa.parse(file, {
                    delimiter: delimiter,
                    skipEmptyLines: true,
                    complete: results => {
                        customParsedData = results.data;
                        displayPreview(results.data);
                    }
                });
            }
        }

        function displayPreview(data) {
            const headerRow = parseInt(document.getElementById('headerRowInput').value);
            const previewRows = data.slice(0, Math.min(10, data.length));
            const table = document.getElementById('previewTable');
            table.innerHTML = '';
            previewRows.forEach((row, idx) => {
                const tr = table.insertRow();
                row.forEach(cell => {
                    const cellEl = tr.insertCell();
                    cellEl.outerHTML = `<${idx === headerRow ? 'th' : 'td'}>${cell || ''}</${idx === headerRow ? 'th' : 'td'}>`;
                });
            });
            document.getElementById('previewTableContainer').style.display = 'block';
            createColumnMappings(data[headerRow] || data[0]);
        }

        function createColumnMappings(headers) {
            const container = document.getElementById('columnMappings');
            container.innerHTML = '';
            const variables = ['UV', 'pH', 'Conductivity', 'Gradient', 'Flow rate', 'System Pressure'];
            variables.forEach(varName => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${varName}:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <select id="x_${varName}">${['<option value="">X-axis (Volume/Time)</option>'].concat(headers.map((h, i) => `<option value="${i}">Col ${i}: ${h || 'Unnamed'}</option>`)).join('')}</select>
                        <select id="y_${varName}">${['<option value="">Y-axis (Value)</option>'].concat(headers.map((h, i) => `<option value="${i}">Col ${i}: ${h || 'Unnamed'}</option>`)).join('')}</select>
                    </div>`;
                container.appendChild(div);
            });
            document.getElementById('columnMappingSection').style.display = 'block';
            document.getElementById('importCustomBtn').disabled = false;
        }

        function openConcentrationCalculator() {
            document.getElementById('extCoeffInput').value = concentrationParams.extCoeff;
            document.getElementById('pathLengthInput').value = concentrationParams.pathLength;
            document.getElementById('molecularWeightInput').value = concentrationParams.mw;

            const resultsDiv = document.getElementById('calcIntegrationResults');
            resultsDiv.innerHTML = 
                '<div><strong>Integration Range:</strong> ' + integrationResults.start.toFixed(2) + ' - ' + integrationResults.end.toFixed(2) + ' mL</div>' +
                '<div><strong>Peak Area:</strong> ' + integrationResults.area.toFixed(2) + ' mL¬∑mAU</div>' +
                '<div><strong>Peak Volume:</strong> ' + integrationResults.volume.toFixed(2) + ' mL</div>';
            
            document.getElementById('concentrationModal').style.display = 'block';
            calculateConcentration(); 
        }

        function calculateConcentration() {
            concentrationParams.extCoeff = parseFloat(document.getElementById('extCoeffInput').value);
            concentrationParams.pathLength = parseFloat(document.getElementById('pathLengthInput').value);
            concentrationParams.mw = parseFloat(document.getElementById('molecularWeightInput').value);
            
            updateConcentrationDisplay(); 
        }

        function openFractionManager() {
            renderFractionList();
            document.getElementById('fractionModal').style.display = 'block';
        }

        function updateConcentrationDisplay() {
            const { extCoeff, pathLength, mw } = concentrationParams;
            const mainAmountEl = document.getElementById('integAmountVal');
            const modalAmountEl = document.getElementById('calculatedAmount');

            if (isNaN(extCoeff) || isNaN(pathLength) || isNaN(mw) || extCoeff === 0 || pathLength === 0 || integrationResults.area === 0) {
                const resultString = integrationResults.area === 0 ? '-' : 'N/A';
                if(mainAmountEl) mainAmountEl.textContent = resultString;
                if(modalAmountEl) modalAmountEl.textContent = resultString;
                return;
            }
            
            const amount = (integrationResults.area * mw) / (extCoeff * pathLength * 1000);
            const resultString = amount.toFixed(3) + ' mg';
            
            if(mainAmountEl) mainAmountEl.textContent = resultString;
            if(modalAmountEl) modalAmountEl.textContent = resultString;
        }

        function renderFractionList() {
            const container = document.getElementById('fractionList');
            if (fractionData.length === 0) {
                container.innerHTML = '<p style="color: #999;">No fractions defined</p>';
                return;
            }
            container.innerHTML = '';
            fractionData.sort((a, b) => a.position - b.position);
            
            fractionData.forEach((fraction, idx) => {
                const div = document.createElement('div');
                div.className = 'fraction-item';

                const leftSide = document.createElement('div');
                leftSide.style.cssText = 'display: flex; align-items: center; flex-grow: 1; margin-right: 10px;';

                const showCheck = document.createElement('input');
                showCheck.type = 'checkbox';
                showCheck.checked = fraction.show !== false;
                showCheck.style.marginRight = '8px';
                showCheck.onchange = function() { fractionData[idx].show = this.checked; };

                const info = document.createElement('div');
                info.innerHTML = `<strong>${fraction.label}</strong> @ ${fraction.position.toFixed(2)} mL`;
                info.style.flexGrow = '1';

                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.value = fraction.label;
                editInput.style.cssText = 'width: 150px; display: none;';
                editInput.id = 'edit_' + idx;

                const btnGroup = document.createElement('div');
                btnGroup.style.cssText = 'display: flex; gap: 5px; flex-shrink: 0;';
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'button-secondary';
                editBtn.onclick = () => {
                    if (editInput.style.display === 'none') {
                        info.style.display = 'none';
                        editInput.style.display = 'block';
                        editBtn.textContent = 'Save';
                    } else {
                        fraction.label = editInput.value;
                        info.innerHTML = `<strong>${fraction.label}</strong> @ ${fraction.position.toFixed(2)} mL`;
                        info.style.display = 'block';
                        editInput.style.display = 'none';
                        editBtn.textContent = 'Edit';
                    }
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'button-danger';
                deleteBtn.onclick = () => {
                    fractionData.splice(idx, 1);
                    renderFractionList();
                };
                
                btnGroup.appendChild(editBtn);
                btnGroup.appendChild(deleteBtn);
                leftSide.appendChild(showCheck);
                leftSide.appendChild(info);
                leftSide.appendChild(editInput);
                div.appendChild(leftSide);
                div.appendChild(btnGroup);
                container.appendChild(div);
            });
        }

        function addFraction() {
            const pos = parseFloat(document.getElementById('newFractionPos').value);
            const label = document.getElementById('newFractionLabel').value.trim();
            if (isNaN(pos) || !label) { alert('Please enter both position and label'); return; }
            fractionData.push({ position: pos, label: label, show: true });
            document.getElementById('newFractionPos').value = '';
            document.getElementById('newFractionLabel').value = '';
            renderFractionList();
        }

        function saveFractions() {
            closeModal('fractionModal');
            if (document.getElementById('showFractionsCheck').checked) plotGraph();
            updateStatus('Fractions saved: ' + fractionData.length + ' fraction(s)');
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function updateStatus(message) { document.getElementById('statusBar').textContent = message; }

        document.getElementById('primaryVarSelect').addEventListener('change', setupIntegrationInputs);

        document.getElementById('integStartValue').addEventListener('change', function() {
            snapToFraction('integStartValue'); 
            updateIntegration();
            if (Object.keys(rawData).length > 0) plotGraph();
        });

        document.getElementById('integEndValue').addEventListener('change', function() {
            snapToFraction('integEndValue'); 
            updateIntegration();
            if (Object.keys(rawData).length > 0) plotGraph();
        });

        window.onclick = event => {
            if (event.target.className === 'modal') event.target.style.display = 'none';
        };

        console.log('Advanced Chromatogram Analyzer initialized');
    </script>
</body>
</html>